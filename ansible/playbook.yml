---
# 1. ALL
- name: Basic Setup
  hosts: all
  become: yes
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes

# 2. WEB
- name: Webserver Configuration
  hosts: webservers
  become: yes
  tasks:
    - name: Install Nginx
      apt: 
        name: nginx
        state: present

    - name: Create custom index.html
      copy:
        content: |
          <html>
          <head><title>Netology - BorzovES</title></head>
          <body>
            <h1>Это {{ inventory_hostname }}</h1>
            <p>It's alive!</p>
          </body>
          </html>
        dest: /var/www/html/index.html
        #owner: www-data
        #group: www-data
        #mode: '0644'

    - name: Download Filebeat
      get_url:
        url: "https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-{{ elastic_version }}-amd64.deb"
        dest: "/tmp/filebeat.deb"
        mode: '0644'

    - name: Install Filebeat
      apt:
        deb: "/tmp/filebeat.deb"

    - name: Configure Filebeat
      lineinfile:
        path: /etc/filebeat/filebeat.yml
        regexp: 'hosts: \["localhost:9200"\]'
        line: '  hosts: ["elasticsearch.ru-central1-a.internal:9200"]'
      notify: Restart Filebeat

    - name: Install Zabbix Agent
      apt:
        name: zabbix-agent
        state: present

    - name: Point Zabbix Agent to Server
      lineinfile:
        path: /etc/zabbix/zabbix_agentd.conf
        regexp: '^Server='
        line: "Server=zabbix.ru-central1-a.internal"
      notify: Restart Zabbix Agent

  handlers:
    - name: Restart Filebeat
      service:
        name: filebeat
        state: restarted
    - name: Restart Zabbix Agent
      service:
        name: zabbix-agent
        state: restarted

# 3. ZABBIX
- name: Setup Zabbix Server, DB, and Frontend
  hosts: zabbix
  become: yes
  tasks:
    - name: Download Zabbix Release Package
      get_url:
        url: "https://repo.zabbix.com/zabbix/7.4/release/ubuntu/pool/main/z/zabbix-release/zabbix-release_latest_7.4+ubuntu22.04_all.deb"
        dest: "/tmp/zabbix-release.deb"

    - name: Install Zabbix Repo
      apt:
        deb: "/tmp/zabbix-release.deb"

    - name: Update apt cache
      apt: 
        update_cache: yes

    - name: Install MySQL, PHP, and Zabbix dependencies
      apt: 
        name:
          - nginx
          - mysql-server
          - python3-pymysql
          - php-fpm
          - php-mysql
          - zabbix-sql-scripts
          - zabbix-server-mysql
          - zabbix-frontend-php
          - zabbix-nginx-conf
        state: present

    - name: Enable Zabbix Nginx config
      shell: |
        sed -i 's/# listen 80;/listen 80;/' /etc/zabbix/nginx.conf
        sed -i 's/# server_name example.com;/server_name _;/' /etc/zabbix/nginx.conf

    - name: Symlink Zabbix Nginx config
      file:
        src: /etc/zabbix/nginx.conf
        dest: /etc/nginx/conf.d/zabbix.conf
        state: link

    - name: Ensure MySQL is running
      service:
        name: mysql
        state: started
        enabled: yes

    - name: Create Zabbix Database
      mysql_db:
        name: zabbix
        encoding: utf8mb4
        collation: utf8mb4_bin
        login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: Create Zabbix DB User
      mysql_user:
        name: zabbix
        password: "{{ db_password }}"
        priv: 'zabbix.*:ALL'
        login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: Enable trust_function_creators for import
      mysql_variables:
        variable: log_bin_trust_function_creators
        value: '1'
        login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: Import Initial Zabbix Schema
      shell: zcat /usr/share/zabbix-sql-scripts/mysql/server.sql.gz | mysql -uzabbix -p{{ db_password }} zabbix
      args:
        creates: /var/lib/mysql/zabbix/users.ibd

    - name: Disable trust_function_creators after import
      mysql_variables:
        variable: log_bin_trust_function_creators
        value: '0'
        login_unix_socket: /var/run/mysqld/mysqld.sock

    - name: Configure Zabbix Server to use the DB
      lineinfile:
        path: /etc/zabbix/zabbix_server.conf
        regexp: '^# DBPassword='
        line: "DBPassword={{ db_password }}"

    - name: Start Services
      service:
        name: "{{ item }}"
        state: restarted
        enabled: yes
      loop: [zabbix-server, nginx, php8.1-fpm]

# 4. ES
- name: Setup Elasticsearch (Native Package)
  hosts: elastic
  become: yes
  tasks:
    - name: Install System Dependencies
      apt:
        name:
          - openjdk-17-jdk     # Standard Java environment
          - wget                # For downloading the package
          - apt-transport-https # For secure communication
          - gnupg               # For handling keys (if needed)
        state: present
        update_cache: yes

    - name: Increase Virtual Memory (mmap counts)
      # Elasticsearch requires this to be at least 262144
      sysctl:
        name: vm.max_map_count
        value: '262144'
        state: present
        reload: yes

    - name: Download Elasticsearch 8.11.0
      get_url:
        url: "https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-{{ elastic_version }}-amd64.deb"
        dest: "/tmp/elasticsearch.deb"
        mode: '0644'

    - name: Install Elasticsearch from deb
      apt:
        deb: "/tmp/elasticsearch.deb"

    - name: Set JVM Heap Size (Memory Dependency)
      # Since you have 8GB RAM, we dedicate 4GB to the Heap
      copy:
        dest: /etc/elasticsearch/jvm.options.d/heap.options
        content: |
          -Xms4g
          -Xmx4g
        owner: root
        group: elasticsearch
        mode: '0660'

    - name: Configure Elasticsearch for External Access
      lineinfile:
        path: /etc/elasticsearch/elasticsearch.yml
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: '^#network.host:', line: 'network.host: 0.0.0.0' }
        - { regexp: '^xpack.security.enabled:', line: 'xpack.security.enabled: false' }
        - { regexp: '^discovery.type:', line: 'discovery.type: single-node' }

    - name: Ensure Elasticsearch is started and enabled
      service:
        name: elasticsearch
        state: started
        enabled: yes
# 5. KIBANA
- name: Setup Kibana (Native Package)
  hosts: kibana
  become: yes
  tasks:
    - name: Wait for Elasticsearch to be ready
      # The wait_for module pauses the playbook execution
      wait_for:
        host: "elasticsearch.ru-central1-a.internal"
        port: 9200
        state: started
        delay: 10      # Don't even check for the first 10 seconds
        timeout: 300   # Give up after 5 minutes (Elastic can be slow to boot)

    - name: Download Kibana 8.11.0
      get_url:
        url: "https://artifacts.elastic.co/downloads/kibana/kibana-{{ elastic_version }}-amd64.deb"
        dest: "/tmp/kibana.deb"
        mode: '0644'

    - name: Install Kibana
      apt:
        deb: "/tmp/kibana.deb"

    - name: Configure Kibana
      lineinfile:
        path: /etc/kibana/kibana.yml
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
      loop:
        - { regexp: '^#server.host:', line: 'server.host: "0.0.0.0"' }
        - { regexp: '^#elasticsearch.hosts:', line: 'elasticsearch.hosts: ["http://elasticsearch.ru-central1-a.internal:9200"]' }

    - name: Start Kibana
      service:
        name: kibana
        state: started
        enabled: yes
